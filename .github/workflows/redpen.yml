name: Red Pen Review

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # Parse language from comment (e.g., "/redpen ko" or "/redpen full zh")
  parse-command:
    if: >
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/redpen')
    runs-on: ubuntu-latest
    outputs:
      language: ${{ steps.parse.outputs.language }}
      is_full: ${{ steps.parse.outputs.is_full }}
    steps:
      - name: Parse command
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          # Check if full review
          if echo "$COMMENT" | grep -q '/redpen full'; then
            echo "is_full=true" >> $GITHUB_OUTPUT
          else
            echo "is_full=false" >> $GITHUB_OUTPUT
          fi
          # Extract language code (ko, zh, ja, vi)
          # Match patterns like "/redpen ko", "/redpen full ko", "/redpen full zh"
          if echo "$COMMENT" | grep -qE '/redpen (full )?(ko|zh|ja|vi)(\s|$)'; then
            LANG=$(echo "$COMMENT" | grep -oE '(ko|zh|ja|vi)' | head -1)
          else
            LANG="en"
          fi
          echo "language=$LANG" >> $GITHUB_OUTPUT

      - name: React with flag
        if: steps.parse.outputs.language != 'en'
        uses: actions/github-script@v7
        with:
          script: |
            const flags = { ko: 'ðŸ‡°ðŸ‡·', zh: 'ðŸ‡¨ðŸ‡³', ja: 'ðŸ‡¯ðŸ‡µ', vi: 'ðŸ‡»ðŸ‡³' };
            const lang = '${{ steps.parse.outputs.language }}';
            const flag = flags[lang];
            if (flag) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ github.event.issue.number }},
                body: flag
              });
            }

  diff-review:
    needs: parse-command
    if: needs.parse-command.outputs.is_full == 'false'
    uses: kaist-comet/redpen-workflow/.github/workflows/latex-paper-review.yml@main
    with:
      comment_id: ${{ github.event.comment.id }}
      pr_number: "${{ github.event.issue.number }}"
      language: ${{ needs.parse-command.outputs.language }}
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  full-review:
    needs: parse-command
    if: needs.parse-command.outputs.is_full == 'true'
    uses: kaist-comet/redpen-workflow/.github/workflows/latex-review-on-demand.yml@main
    with:
      comment_id: ${{ github.event.comment.id }}
      pr_number: "${{ github.event.issue.number }}"
      language: ${{ needs.parse-command.outputs.language }}
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}